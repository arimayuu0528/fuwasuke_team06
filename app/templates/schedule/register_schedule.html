{% extends "base3.html" %} {% block title %}固定タスク登録{% endblock %} {%block
content %}
<div class="sched-header">
  <h1 class="sched-title">固定タスク登録</h1>
  <div class="sched-tab-container">
    <button class="sched-tab">タスク登録</button>
    <button class="sched-tab sched-tab-active">固定タスク登録</button>
  </div>
</div>

<div class="sched-form-container">
  <form
    id="schedTaskForm"
    method="POST"
    action="{{ url_for('.schedule_form') }}"
  >
    <div class="sched-form-section">
      <div class="sched-form-label">
        <span>タスク名</span>
        <a href="#" class="sched-template-link">固定タスク一覧 ☰</a>
      </div>
      <input
        type="text"
        name="title"
        class="sched-form-input"
        placeholder="何をする？"
        value="{{ task.title if task else '' }}"
        required
      />
    </div>

    <div class="sched-form-section">
      <div class="sched-time-inputs">
        <div class="sched-time-input-wrapper">
          <span class="sched-time-label">開始時間</span>
          <input
            type="time"
            name="start_time"
            class="sched-time-input"
            value="{{ task.start_time if task else '09:10' }}"
            required
          />
        </div>
        <div class="sched-time-input-wrapper">
          <span class="sched-time-label">終了時間</span>
          <input
            type="time"
            name="end_time"
            class="sched-time-input"
            value="{{ task.end_time if task else '09:50' }}"
            required
          />
        </div>
      </div>
    </div>

    <div class="sched-form-section">
      <div class="sched-form-label">繰り返す曜日</div>
      <div class="sched-weekday-selector">
        {% set weekdays = ['月', '火', '水', '木', '金', '土', '日'] %} {% for
        day in weekdays %}
        <button type="button" class="sched-weekday-btn" data-day="{{ day }}">
          {{ day }}
        </button>
        {% endfor %}
      </div>
      <input type="hidden" name="active_days" id="schedActiveDays" value="" />
    </div>

    <div class="sched-form-section">
      <div class="sched-form-label">カテゴリー</div>
      <div class="sched-category-selector">
        {% for category in categories %}
        <button
          type="button"
          class="sched-category-btn {% if loop.first %}sched-category-active{% endif %}"
          onclick="schedSelectCategory(this)"
        >
          {{ category }}
        </button>
        {% endfor %}
      </div>
      <input
        type="hidden"
        name="category"
        id="schedCategory"
        value="{{ categories[0] if categories else 'セルフケア' }}"
      />
    </div>

    <div class="sched-form-section">
      <div class="sched-form-label">モチベーション</div>
      <textarea
        name="memo"
        class="sched-memo-textarea"
        placeholder="タスクのメモや手順を入力してください"
      >
{{ task.memo if task else '' }}</textarea
      >
    </div>

    <div class="sched-info-box">
      <span class="sched-info-icon"><img src="" alt="" /></span>
      <p class="sched-info-text">
        固定タスクは毎週決まった時間にカレンダーに追加されるよ
      </p>
    </div>
  </form>
</div>

<button type="submit" form="schedTaskForm" class="sched-submit-btn">
  登録
</button>
<script>
  // Fixed Task Registration Form - Complete JavaScript

  // Initialize form on page load
  document.addEventListener("DOMContentLoaded", function () {
    schedInitializeForm();
    schedSetupFormValidation();
    schedSetupTimeInputs();
    schedSetupCategorySelection();
    schedSetupWeekdaySelection();
    schedAddRippleEffects();
    schedSetupFormSubmission();
  });

  // Initialize form with default values
  function schedInitializeForm() {
    // Set initial active days value
    schedUpdateActiveDaysInput();

    // Set initial category value
    const activeCategory = document.querySelector(
      ".sched-category-btn.sched-category-active",
    );
    if (activeCategory) {
      document.getElementById("schedCategory").value =
        activeCategory.textContent.trim();
    }

    // Auto-focus on task name input
    const taskNameInput = document.querySelector(
      '.sched-form-input[name="title"]',
    );
    if (taskNameInput && !taskNameInput.value) {
      setTimeout(() => {
        taskNameInput.focus();
      }, 300);
    }
  }

  // Toggle weekday selection
  // Toggle weekday selection
  function schedToggleWeekday(btn) {
    // トグル処理
    btn.classList.toggle("sched-weekday-active");

    // Add haptic feedback if available
    if (navigator.vibrate) {
      navigator.vibrate(10);
    }

    // Update hidden input
    schedUpdateActiveDaysInput();
  }

  // Update active days hidden input
  function schedUpdateActiveDaysInput() {
    const actives = document.querySelectorAll(
      ".sched-weekday-btn.sched-weekday-active",
    );
    const days = Array.from(actives)
      .map((b) => b.dataset.day)
      .join("");
    document.getElementById("schedActiveDays").value = days;

    console.log("Selected days:", days); // デバッグ用
  }
  // Select category
  function schedSelectCategory(btn) {
    // Remove active class from all category buttons
    const categoryBtns = document.querySelectorAll(".sched-category-btn");
    categoryBtns.forEach((b) => b.classList.remove("sched-category-active"));

    // Add active class to clicked button
    btn.classList.add("sched-category-active");

    // Update hidden input
    document.getElementById("schedCategory").value = btn.textContent.trim();

    // Add haptic feedback if available
    if (navigator.vibrate) {
      navigator.vibrate(10);
    }

    // Add ripple effect
    schedAddRipple(btn, event);
  }

  // Setup form validation
  function schedSetupFormValidation() {
    const form = document.getElementById("schedTaskForm");
    const inputs = form.querySelectorAll("input[required], textarea[required]");

    inputs.forEach((input) => {
      input.addEventListener("blur", function () {
        schedValidateField(this);
      });

      input.addEventListener("input", function () {
        if (this.classList.contains("sched-error")) {
          schedValidateField(this);
        }
      });
    });
  }

  // Validate individual field
  function schedValidateField(field) {
    if (!field.value.trim() && field.hasAttribute("required")) {
      field.classList.add("sched-error");
      return false;
    } else {
      field.classList.remove("sched-error");
      return true;
    }
  }

  // Setup time inputs
  function schedSetupTimeInputs() {
    const timeInputs = document.querySelectorAll(".sched-time-input");

    timeInputs.forEach((input) => {
      // Format time on change
      input.addEventListener("change", function () {
        schedFormatTimeInput(this);
      });

      // Add focus animation
      input.addEventListener("focus", function () {
        this.parentElement.style.transform = "scale(1.02)";
        this.parentElement.style.transition = "transform 0.2s";
      });

      input.addEventListener("blur", function () {
        this.parentElement.style.transform = "scale(1)";
      });
    });

    // Validate end time is after start time
    const startTime = document.querySelector('input[name="start_time"]');
    const endTime = document.querySelector('input[name="end_time"]');

    if (startTime && endTime) {
      const validateTimes = () => {
        if (startTime.value && endTime.value) {
          const start = schedTimeToMinutes(startTime.value);
          const end = schedTimeToMinutes(endTime.value);

          if (end <= start) {
            endTime.setCustomValidity("終了時間は開始時間より後にしてください");
            schedShowToast("終了時間は開始時間より後にしてください", "warning");
          } else {
            endTime.setCustomValidity("");
          }
        }
      };

      startTime.addEventListener("change", validateTimes);
      endTime.addEventListener("change", validateTimes);
    }
  }

  // Convert time to minutes for comparison
  function schedTimeToMinutes(time) {
    const [hours, minutes] = time.split(":").map(Number);
    return hours * 60 + minutes;
  }

  // Format time input
  function schedFormatTimeInput(input) {
    let value = input.value;
    if (value) {
      // Ensure proper format
      const [hours, minutes] = value.split(":");
      const formattedHours = hours.padStart(2, "0");
      const formattedMinutes = minutes.padStart(2, "0");
      input.value = `${formattedHours}:${formattedMinutes}`;
    }
  }

  // Setup category selection
  function schedSetupCategorySelection() {
    const categoryBtns = document.querySelectorAll(".sched-category-btn");

    categoryBtns.forEach((btn) => {
      btn.addEventListener("click", function (e) {
        e.preventDefault();
        schedSelectCategory(this);
      });
    });
  }

  // Setup weekday selection
  // Setup weekday selection
  function schedSetupWeekdaySelection() {
    const weekdayBtns = document.querySelectorAll(".sched-weekday-btn");

    weekdayBtns.forEach((btn) => {
      btn.addEventListener("click", function (e) {
        e.preventDefault();
        e.stopPropagation();

        // トグル処理
        this.classList.toggle("sched-weekday-active");

        // Add haptic feedback if available
        if (navigator.vibrate) {
          navigator.vibrate(10);
        }

        // Update hidden input
        schedUpdateActiveDaysInput();
      });
    });
  }

  // Add ripple effects to buttons
  function schedAddRippleEffects() {
    const buttons = document.querySelectorAll(
      ".sched-weekday-btn, .sched-category-btn, .sched-submit-btn",
    );

    buttons.forEach((button) => {
      button.addEventListener("click", function (e) {
        schedAddRipple(this, e);
      });
    });
  }

  // Add ripple effect to element
  function schedAddRipple(element, event) {
    const ripple = document.createElement("span");
    ripple.classList.add("sched-ripple");

    const rect = element.getBoundingClientRect();
    const size = Math.max(rect.width, rect.height);
    const x = event.clientX - rect.left - size / 2;
    const y = event.clientY - rect.top - size / 2;

    ripple.style.width = ripple.style.height = size + "px";
    ripple.style.left = x + "px";
    ripple.style.top = y + "px";

    // Remove existing ripples
    const existingRipples = element.querySelectorAll(".sched-ripple");
    existingRipples.forEach((r) => r.remove());

    element.appendChild(ripple);

    setTimeout(() => ripple.remove(), 600);
  }

  // Setup form submission
  function schedSetupFormSubmission() {
    const form = document.getElementById("schedTaskForm");
    const submitBtn = document.querySelector(".sched-submit-btn");

    form.addEventListener("submit", function (e) {
      e.preventDefault();

      // Validate form
      if (!schedValidateForm()) {
        schedShowToast("入力内容を確認してください", "error");
        return;
      }

      // Show loading state
      submitBtn.classList.add("sched-loading");
      submitBtn.disabled = true;

      // Haptic feedback
      if (navigator.vibrate) {
        navigator.vibrate([10, 50, 10]);
      }

      // Simulate form submission (remove this in production)
      setTimeout(() => {
        // Submit the form
        form.submit();

        // Or handle with AJAX:
        // schedSubmitFormAjax(form);
      }, 500);
    });
  }

  // Validate entire form
  function schedValidateForm() {
    const form = document.getElementById("schedTaskForm");
    const requiredInputs = form.querySelectorAll(
      "input[required], textarea[required]",
    );
    let isValid = true;

    // Check task name
    const taskName = form.querySelector('input[name="title"]');
    if (!taskName.value.trim()) {
      isValid = false;
      taskName.classList.add("sched-error");
    }

    // Check times
    const startTime = form.querySelector('input[name="start_time"]');
    const endTime = form.querySelector('input[name="end_time"]');
    if (!startTime.value || !endTime.value) {
      isValid = false;
    }

    // Check at least one weekday selected
    const activeDays = document.getElementById("schedActiveDays").value;
    if (!activeDays) {
      schedShowToast("繰り返す曜日を選択してください", "warning");
      isValid = false;
    }

    // Check category selected
    const category = document.getElementById("schedCategory").value;
    if (!category) {
      schedShowToast("カテゴリーを選択してください", "warning");
      isValid = false;
    }

    return isValid;
  }

  // Submit form via AJAX (optional)
  function schedSubmitFormAjax(form) {
    const formData = new FormData(form);

    fetch(form.action, {
      method: "POST",
      body: formData,
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          schedShowToast("固定タスクを登録しました", "success");
          setTimeout(() => {
            window.location.href = data.redirect || "/schedule/list";
          }, 1000);
        } else {
          schedShowToast(data.message || "エラーが発生しました", "error");
          document
            .querySelector(".sched-submit-btn")
            .classList.remove("sched-loading");
          document.querySelector(".sched-submit-btn").disabled = false;
        }
      })
      .catch((error) => {
        console.error("Error:", error);
        schedShowToast("エラーが発生しました", "error");
        document
          .querySelector(".sched-submit-btn")
          .classList.remove("sched-loading");
        document.querySelector(".sched-submit-btn").disabled = false;
      });
  }

  // Show toast notification
  function schedShowToast(message, type = "info") {
    // Remove existing toasts
    const existingToasts = document.querySelectorAll(".sched-toast");
    existingToasts.forEach((toast) => toast.remove());

    const toast = document.createElement("div");
    toast.className = `sched-toast sched-toast-${type}`;
    toast.textContent = message;

    const styles = {
      position: "fixed",
      top: "80px",
      left: "50%",
      transform: "translateX(-50%)",
      padding: "12px 24px",
      borderRadius: "24px",
      color: "#fff",
      fontSize: "14px",
      fontWeight: "500",
      zIndex: "10000",
      animation: "schedSlideDown 0.3s ease-out",
      boxShadow: "0 4px 12px rgba(0, 0, 0, 0.15)",
    };

    Object.assign(toast.style, styles);

    // Set background color based on type
    const colors = {
      success: "#4CAF50",
      error: "#ff6b6b",
      warning: "#FF9F5A",
      info: "#2196F3",
    };
    toast.style.background = colors[type] || colors.info;

    document.body.appendChild(toast);

    // Add animation
    const keyframes = `
    @keyframes schedSlideDown {
      from {
        opacity: 0;
        transform: translateX(-50%) translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    }
  `;

    const styleSheet = document.createElement("style");
    styleSheet.textContent = keyframes;
    document.head.appendChild(styleSheet);

    // Auto remove after 3 seconds
    setTimeout(() => {
      toast.style.animation = "schedSlideUp 0.3s ease-out";
      setTimeout(() => toast.remove(), 300);
    }, 3000);
  }

  // Auto-save draft (optional feature)
  function schedSetupAutoSave() {
    const form = document.getElementById("schedTaskForm");
    const inputs = form.querySelectorAll("input, textarea");

    inputs.forEach((input) => {
      input.addEventListener(
        "input",
        schedDebounce(function () {
          schedSaveDraft();
        }, 1000),
      );
    });
  }

  // Save form data to localStorage
  function schedSaveDraft() {
    const form = document.getElementById("schedTaskForm");
    const formData = new FormData(form);
    const data = {};

    for (let [key, value] of formData.entries()) {
      data[key] = value;
    }

    data.activeDays = document.getElementById("schedActiveDays").value;
    data.category = document.getElementById("schedCategory").value;

    localStorage.setItem("schedTaskDraft", JSON.stringify(data));
    console.log("Draft saved");
  }

  // Load draft from localStorage
  function schedLoadDraft() {
    const draft = localStorage.getItem("schedTaskDraft");
    if (draft) {
      const data = JSON.parse(draft);

      // Fill form with draft data
      Object.keys(data).forEach((key) => {
        const input = document.querySelector(`[name="${key}"]`);
        if (input) {
          input.value = data[key];
        }
      });

      // Restore weekday selections
      if (data.activeDays) {
        const days = data.activeDays.split("");
        const weekdayBtns = document.querySelectorAll(".sched-weekday-btn");
        weekdayBtns.forEach((btn) => {
          if (days.includes(btn.dataset.day)) {
            btn.classList.add("sched-weekday-active");
          } else {
            btn.classList.remove("sched-weekday-active");
          }
        });
      }

      // Restore category selection
      if (data.category) {
        const categoryBtns = document.querySelectorAll(".sched-category-btn");
        categoryBtns.forEach((btn) => {
          if (btn.textContent.trim() === data.category) {
            btn.classList.add("sched-category-active");
          } else {
            btn.classList.remove("sched-category-active");
          }
        });
      }
    }
  }

  // Debounce function
  function schedDebounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }

  // Clear draft after successful submission
  function schedClearDraft() {
    localStorage.removeItem("schedTaskDraft");
  }

  // Character counter for memo textarea (optional)
  function schedSetupCharacterCounter() {
    const textarea = document.querySelector(".sched-memo-textarea");
    if (textarea) {
      const counter = document.createElement("div");
      counter.className = "sched-character-counter";
      counter.style.cssText =
        "text-align: right; color: #999; font-size: 12px; margin-top: 4px;";

      textarea.parentElement.appendChild(counter);

      const updateCounter = () => {
        const length = textarea.value.length;
        const maxLength = textarea.getAttribute("maxlength") || 500;
        counter.textContent = `${length} / ${maxLength}`;

        if (length > maxLength * 0.9) {
          counter.style.color = "#ff6b6b";
        } else {
          counter.style.color = "#999";
        }
      };

      textarea.addEventListener("input", updateCounter);
      updateCounter();
    }
  }
</script>

{% endblock %}
