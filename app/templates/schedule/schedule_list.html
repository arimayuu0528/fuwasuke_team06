{% extends "base3.html" %} {% block title %} å›ºå®šã‚¿ã‚¹ã‚¯ä¸€è¦§{% endblock %} {%
block content %}
<div class="fixed-task-page">
  <div class="header">
    <h1>å›ºå®šã‚¿ã‚¹ã‚¯ä¸€è¦§</h1>
    <div class="tab-container">
      <button class="tab">ã‚¿ã‚¹ã‚¯</button>
      <button class="tab active">å›ºå®šã‚¿ã‚¹ã‚¯</button>
    </div>
  </div>

  <div class="task-list">
    {% for task in tasks %}
    <div class="task-card">
      <div class="task-header">
        <div class="task-title">{{ task.title }}</div>
        <button class="delete-btn" data-task-id="{{ task.id }}">ğŸ—‘</button>
      </div>

      <div class="task-meta">
        <span class="task-category">{{ task.category }}</span>
        <span class="task-time">{{ task.start_time }}~{{ task.end_time }}</span>
      </div>

      {% if task.comment %}
      <div class="comment-section">
        <button class="comment-toggle" onclick="toggleComment(this)">
          <span class="arrow">â–¼</span>
          <span>ã‚³ãƒ¡ãƒ³ãƒˆ</span>
        </button>
        <div class="comment-content">{{ task.comment }}</div>
      </div>
      {% endif %}

      <div class="weekday-pills">
        {% for day in ['æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ', 'æ—¥'] %}
        <div
          class="weekday {% if day in task.active_days %}active{% else %}inactive{% endif %}"
        >
          {{ day }}
        </div>
        {% endfor %}
      </div>
    </div>
    {% endfor %}
  </div>

  <button
    class="add-task-btn"
    onclick="location.href='{{ url_for('schedule.schedule_form') }}'"
  >
    æ–°ã—ã„å›ºå®šã‚¿ã‚¹ã‚¯ã‚’ä½œæˆ
  </button>

  {% if tasks|length == 0 %}
  <p class="empty-message">ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“</p>
  {% endif %}

  <p class="task-count">ä»¶æ•°ï¼š{{ tasks|length }}</p>
</div>

<!-- ã‚«ã‚¹ã‚¿ãƒ å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="deleteModal" class="delete-modal">
  <div class="delete-modal-content">
    <div class="delete-modal-icon">ğŸ—‘ï¸</div>
    <h3 class="delete-modal-title">ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ</h3>
    <p class="delete-modal-text">ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“</p>
    <div class="delete-modal-buttons">
      <button
        class="delete-modal-btn delete-cancel-btn"
        onclick="closeDeleteModal()"
      >
        ã‚­ãƒ£ãƒ³ã‚»ãƒ«
      </button>
      <button
        class="delete-modal-btn delete-confirm-btn"
        onclick="confirmDelete()"
      >
        å‰Šé™¤ã™ã‚‹
      </button>
    </div>
  </div>
</div>

<script>
  let pendingDeleteTaskId = null;

  // DOMContentLoadedã§å‰Šé™¤ãƒœã‚¿ãƒ³ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
  document.addEventListener("DOMContentLoaded", function () {
    const deleteButtons = document.querySelectorAll(".delete-btn");
    deleteButtons.forEach((btn) => {
      btn.addEventListener("click", function (e) {
        e.preventDefault();
        e.stopPropagation();
        const taskId = this.getAttribute("data-task-id");
        console.log("Delete task ID:", taskId);
        pendingDeleteTaskId = taskId;
        showDeleteModal();
      });
    });
  });

  function showDeleteModal() {
    console.log("showDeleteModal - pendingDeleteTaskId:", pendingDeleteTaskId);
    const modal = document.getElementById("deleteModal");
    modal.classList.add("show");

    modal.onclick = function (e) {
      if (e.target === modal) {
        closeDeleteModal();
      }
    };
  }

  function closeDeleteModal() {
    const modal = document.getElementById("deleteModal");
    modal.classList.remove("show");
  }

  function confirmDelete() {
    console.log(
      "confirmDelete called - pendingDeleteTaskId:",
      pendingDeleteTaskId,
    );

    if (!pendingDeleteTaskId) {
      console.error("No task ID to delete");
      return;
    }

    const taskCard = document
      .querySelector(`[data-task-id="${pendingDeleteTaskId}"]`)
      ?.closest(".task-card");

    closeDeleteModal();

    if (taskCard) {
      taskCard.classList.add("deleting");
    }

    setTimeout(
      () => {
        const form = document.createElement("form");
        form.method = "POST";
        form.action = "/schedule/delete/" + pendingDeleteTaskId;
        document.body.appendChild(form);
        console.log("Submitting to:", form.action);
        form.submit();
      },
      taskCard ? 300 : 0,
    );
  }

  // Toggle comment visibility
  function toggleComment(button) {
    const commentContent = button.nextElementSibling;
    if (commentContent.classList.contains("hidden")) {
      commentContent.classList.remove("hidden");
      button.classList.remove("collapsed");
    } else {
      commentContent.classList.add("hidden");
      button.classList.add("collapsed");
    }
  }

  // Initialize comments as collapsed on page load
  document.addEventListener("DOMContentLoaded", function () {
    const commentContents = document.querySelectorAll(".comment-content");
    const commentToggles = document.querySelectorAll(".comment-toggle");

    commentContents.forEach((content) => {
      content.classList.add("hidden");
    });

    commentToggles.forEach((toggle) => {
      toggle.classList.add("collapsed");
    });

    addRippleEffect();
    document.documentElement.style.scrollBehavior = "smooth";
  });

  function addRippleEffect() {
    const buttons = document.querySelectorAll(
      ".add-task-btn, .tab, .weekday.active",
    );
    buttons.forEach((button) => {
      button.addEventListener("click", function (e) {
        const ripple = document.createElement("span");
        ripple.classList.add("ripple");
        const rect = this.getBoundingClientRect();
        const size = Math.max(rect.width, rect.height);
        const x = e.clientX - rect.left - size / 2;
        const y = e.clientY - rect.top - size / 2;
        ripple.style.width = ripple.style.height = size + "px";
        ripple.style.left = x + "px";
        ripple.style.top = y + "px";
        this.appendChild(ripple);
        setTimeout(() => ripple.remove(), 600);
      });
    });
  }

  function switchTab(tabElement) {
    const tabs = document.querySelectorAll(".tab");
    tabs.forEach((tab) => tab.classList.remove("active"));
    tabElement.classList.add("active");
    if (tabElement.textContent.trim() === "ã‚¿ã‚¹ã‚¯") {
      window.location.href = "/tasks";
    }
  }

  document.addEventListener("DOMContentLoaded", function () {
    const tabs = document.querySelectorAll(".tab");
    tabs.forEach((tab) => {
      tab.addEventListener("click", function () {
        switchTab(this);
      });
    });
  });

  document.addEventListener("DOMContentLoaded", function () {
    const touchElements = document.querySelectorAll(
      ".task-card, .weekday, .delete-btn",
    );
    touchElements.forEach((element) => {
      element.addEventListener("touchstart", function () {
        this.style.opacity = "0.7";
      });
      element.addEventListener("touchend", function () {
        this.style.opacity = "1";
      });
      element.addEventListener("touchcancel", function () {
        this.style.opacity = "1";
      });
    });
  });

  function revealOnScroll() {
    const taskCards = document.querySelectorAll(".task-card");
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            entry.target.style.opacity = "1";
            entry.target.style.transform = "translateY(0)";
          }
        });
      },
      { threshold: 0.1 },
    );
    taskCards.forEach((card) => {
      card.style.opacity = "0";
      card.style.transform = "translateY(20px)";
      card.style.transition = "opacity 0.4s, transform 0.4s";
      observer.observe(card);
    });
  }

  document.addEventListener("DOMContentLoaded", revealOnScroll);

  let pressTimer;
  function setupLongPress() {
    const deleteButtons = document.querySelectorAll(".delete-btn");
    deleteButtons.forEach((btn) => {
      btn.addEventListener("touchstart", function (e) {
        pressTimer = setTimeout(() => {
          if (navigator.vibrate) navigator.vibrate(50);
          const taskCard = this.closest(".task-card");
          taskCard.style.transform = "scale(0.98)";
        }, 500);
      });
      btn.addEventListener("touchend", function () {
        clearTimeout(pressTimer);
        const taskCard = this.closest(".task-card");
        taskCard.style.transform = "scale(1)";
      });
      btn.addEventListener("touchcancel", function () {
        clearTimeout(pressTimer);
        const taskCard = this.closest(".task-card");
        taskCard.style.transform = "scale(1)";
      });
    });
  }
  document.addEventListener("DOMContentLoaded", setupLongPress);
</script>
{% endblock %}
