{% extends "base2.html" %}
 
{% block title %}ãƒ›ãƒ¼ãƒ  - ãµã‚ã™ã‘{% endblock %}
 
{% block header_content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/home.css') }}">
<div class="fuwasuke_log1">
    <p><img src="{{url_for('static',filename='image/ãµã‚ã™ã‘1.png')}}" alt="ãƒ­ã‚´"></p>
</div>
{% endblock %}
 
{% block content %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
 
<div class="container">
    <div class="header-msg-row">
        <img src="../../static/image/bouhuwasuke.png" width="50" class="chara-img">
        <div class="message-bubble">
            <p id="dailyMessage">ä»Šæ—¥ã¯ãŸãã•ã‚“ã®äºˆå®šãŒã‚ã‚Šã¾ã™ã€‚<br>ã—ã£ã‹ã‚Šã¨ãŒã‚“ã°ã‚Šã¾ã—ã‚‡ã†ã€‚</p>
        </div>
    </div>
 
    <div class="date-selector">
        <button type="button" class="date-arrow" id="prevDate">â—€</button>
        <div class="date-display" id="currentDateDisplay"></div>
        <button type="button" class="date-arrow" id="nextDate">â–¶</button>
    </div>
 
    <div class="progress-card">
        <div class="progress-info">
            <span class="label">ä»Šæ—¥ã®é”æˆåº¦</span>
            <span class="percent-text" id="percentText">{{ percent | default(0) }}%</span>
        </div>
        <div class="progress-track">
            <div class="progress-bar-fill" id="dynamicBar" style="width: {{ percent | default(0) }}%;"></div>
        </div>
       
        <p class="progress-hint">
            <span class="star">âœ¦</span>
            <span id="remainHint">
            èª­ã¿è¾¼ã¿ä¸­...
            </span>
        </p>
    </div>
 
    <button class="action-btn" id="openEvalModal">ã‚¿ã‚¹ã‚¯æ¡ˆã‚’è©•ä¾¡ã™ã‚‹</button>
 
    <div class="task-section">
        <div class="task-header">
            <h3>æœ¬æ—¥ã®ã‚¿ã‚¹ã‚¯</h3>
            <span id="toggleTasks" class="toggle-link">ã™ã¹ã¦è¦‹ã‚‹ ï¼</span>
        </div>
 
        <div id="task-list" class="task-container" style="display: none;">
            </div>
    </div>
</div>
 
<div id="evaluationModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <button class="modal-close-x" id="closeModal">Ã—</button>
       
        <div class="modal-header-row"id="evalHeader">
            <img src="../../static/image/bouhuwasuke.png" width="45" class="chara-img">
            <div class="modal-bubble">
                <p>ãŠç–²ã‚Œæ§˜ã§ã—ãŸã€‚<br>ã‚¿ã‚¹ã‚¯æ¡ˆã‚’è©•ä¾¡ã—ã¦<br>æ¬²ã—ã„ãªã€‚</p>
            </div>
        </div>
 
        <div class="modal-body" id="evalStep1">
            <h3 class="eval-title">ä»Šå›ã€ææ¡ˆã—ãŸã‚¿ã‚¹ã‚¯ã«å¯¾ã—ã¦<br>æœ€ã‚‚è¿‘ã„è©•ä¾¡ã‚’é¸ã‚“ã§ãã ã•ã„</h3>
           
            <div class="eval-options">
                <button type="button" class="eval-choice" data-value="æº€è¶³">æº€è¶³</button>
                <button type="button" class="eval-choice" data-value="ãµã¤ã†">ãµã¤ã†</button>
                <button type="button" class="eval-choice" data-value="ä¸æº€">ä¸æº€</button>
            </div>
 
            <button type="button" class="eval-submit-btn" id="submitEval" disabled>è©•ä¾¡ã™ã‚‹</button>
        </div>
 
        <div class="modal-body" id="evalStep2" style="display: none; text-align: center; padding: 10px 0 20px;">
            <img src="../../static/image/ozigi.jpg" width="100" style="margin-bottom: 15px;">
            <h3 style="font-size: 18px; color: #333; margin-bottom: 25px; font-weight: bold;">é€ä¿¡ã—ã¾ã—ãŸ</h3>
            <button type="button" class="action-btn" id="backHome" style="width: 160px; margin: 0 auto;">ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</button>
        </div>
    </div>
</div>
 
<style>
/* å›ºå®šãƒ©ãƒ™ãƒ« */
.fixed-label { background: #f9dab5; color: #8a745d; padding: 2px 6px; border-radius: 10px; font-size: 10px; margin-left: 6px; }
 
/* æ—¢å­˜CSS */
.container { padding: 20px; max-width: 400px; margin: 0 auto; padding-bottom: 100px; }
.header-msg-row, .modal-header-row { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; }
.message-bubble, .modal-bubble { background: #fffce7; border: 2px solid #f9dab5; border-radius: 18px; padding: 10px 12px; font-size: 12px !important; color: #8a745d; line-height: 1.4; position: relative; flex: 1; }
.message-bubble::before, .modal-bubble::before { content: ""; position: absolute; left: -18px; top: 50%; transform: translateY(-50%); border: 9px solid transparent; border-right: 9px solid #f9dab5; }
.message-bubble::after, .modal-bubble::after { content: ""; position: absolute; left: -16px; top: 50%; transform: translateY(-50%); border: 8px solid transparent; border-right: 8px solid #fffce7; }
.modal-bubble p { font-size: 12px !important; margin: 0; line-height: 1.4; }
.date-selector { display: flex; justify-content: center; align-items: center; gap: 20px; margin: 20px 0; }
.date-display { font-size: 26px; font-weight: bold; color: #333; min-width: 180px; text-align: center; }
.date-arrow { background: none; border: none; color: #f19710; font-size: 24px; cursor: pointer; }
.progress-card { background: #fff9f0; border-radius: 35px; padding: 25px; border: 1px solid #ffe8d0; margin-bottom: 30px; }
.progress-info { display: flex; justify-content: space-between; margin-bottom: 10px; color: #f19710; font-weight: bold; }
.progress-track { background: #e0e0e0; height: 14px; border-radius: 10px; overflow: hidden; margin-bottom: 10px; }
.progress-bar-fill { background: #fbc02d; height: 100%; transition: width 0.3s ease; }
.progress-hint { font-size: 13px; color: #666; }
.star { color: #333; margin-right: 4px; }
.action-btn { display: block; width: 80%; margin: 0 auto 30px; background: #f09540; color: white; border: none; padding: 12px; border-radius: 25px; font-weight: bold; box-shadow: 0 4px 0 #d47e2a; cursor: pointer; }
.action-btn:active { transform: translateY(2px); box-shadow: 0 2px 0 #d47e2a; }
.action-btn.disabled {background: #ccc !important;box-shadow: 0 4px 0 #aaa !important;cursor: not-allowed !important;pointer-events: none;}
.task-header { display: flex; justify-content: space-between; margin-bottom: 15px; align-items: center; padding: 0 5px; }
.task-header h3 { font-size: 18px; color: #333; }
.toggle-link { color: #f19710; font-size: 14px; cursor: pointer; }
.task-card { display: flex; align-items: center; background: white; border-radius: 40px; padding: 12px 20px; border: 1px solid #eee; margin-bottom: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
.task-check { margin-right: 15px; font-size: 18px; }
.task-checkbox {transition: transform 0.2s ease;}
.task-checkbox:checked {transform: scale(1.3);}
.task-container {max-height: 250px;overflow-y: auto;padding-right: 5px;}
.done-icon { color: #f19710; }
.circle-icon { color: #ccc; }
.task-body { flex: 1; }
.task-title { font-weight: bold; font-size: 15px; color: #333; }
.task-time { font-size: 12px; color: #999; }
.modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.3); backdrop-filter: blur(2px); display: flex; justify-content: center; align-items: center; z-index: 10000; }
.modal-content { background: white; width: 85%; max-width: 340px; border-radius: 30px; padding: 20px 20px 30px; position: relative; border: 2px solid #f09540; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
.modal-close-x { position: absolute; top: 5px; right: 8px; width: 20px !important; height: 20px !important; min-width: 20px; min-height: 20px; padding: 0 !important; background: #f09540; border: none; border-radius: 50% !important; display: flex !important; align-items: center; justify-content: center; box-sizing: border-box; z-index: 10; }
.eval-title { font-size: 14px; color: #333; margin-bottom: 25px; line-height: 1.6; font-weight: bold; text-align: center; }
.eval-options { display: flex; flex-direction: column; gap: 12px; margin-bottom: 30px; }
.eval-choice { background: #f2f2f2; border: 1px solid #eee; padding: 12px; border-radius: 25px; font-size: 14px; color: #333; cursor: pointer; transition: 0.2s; }
 
.eval-choice.selected { background-color: #f09540 !important; color: #fff !important; font-weight: bold !important; border-color: #f09540 !important; }
.eval-choice.disabled { background-color: #ddd !important; color: #888 !important; border-color: #ccc !important; cursor: not-allowed !important; font-weight: normal !important; }
 
/* è©•ä¾¡ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ */
.eval-submit-btn { background-color: #ddd !important; color: #fff; border: none; width: 140px; padding: 12px; border-radius: 25px; font-weight: bold; cursor: not-allowed; display: block; margin: 0 auto; }
.eval-submit-btn.enabled { background-color: #f09540 !important; cursor: pointer; }
</style>
 
<script>
(function(){
    let displayDate = new Date();
    const dayLabels = ["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"];
    const allTasks = {{ rec | default([]) | tojson | safe }};
 
    function refreshDateDisplay(){
        const m = displayDate.getMonth() + 1;
        const d = displayDate.getDate();
        const wIndex = displayDate.getDay();
        const w = dayLabels[wIndex];

        $('#currentDateDisplay').text(`${m}æœˆ${d}æ—¥(${w})`);

        // â˜… ä»Šæ—¥åˆ¤å®š
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
        const viewingDate = new Date(displayDate.getFullYear(), displayDate.getMonth(), displayDate.getDate()).getTime();
        const isToday = (today === viewingDate);

        const $evalBtn = $('#openEvalModal');

        if(isToday){
            $evalBtn.removeClass('disabled');
        } else {
            $evalBtn.addClass('disabled');
        }
        const $message = $('#dailyMessage');

        if(isToday){
            $message.html(`
                ä»Šæ—¥ã¯ãŸãã•ã‚“ã®äºˆå®šãŒã‚ã‚Šã¾ã™ã€‚<br>
                ã—ã£ã‹ã‚Šã¨ãŒã‚“ã°ã‚Šã¾ã—ã‚‡ã†ã€‚
            `);
        } else {
            $message.html(`
                ã“ã®æ—¥ã®è¨˜éŒ²ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚
            `);
        }

        renderTasksForDate(w);
    }
 
    function renderTasksForDate(currentWeek){
        const dateKey = displayDate.toISOString().split('T')[0];
        const storageKey = "task_done_" + dateKey;
        const storedData = JSON.parse(localStorage.getItem(storageKey) || "{}");
        const $list = $('#task-list');
        $list.empty();
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
        const viewingDate = new Date(displayDate.getFullYear(), displayDate.getMonth(), displayDate.getDate()).getTime();
        const isToday = (today === viewingDate);
 
        let displayTasks = [];
        allTasks.forEach(task => {
            if(task.is_fixed){
                if(task.repeat_type === "æ¯æ—¥" || (task.day_of_week && task.day_of_week.indexOf(currentWeek) !== -1)){
                    displayTasks.push(task);
                }
            } else if(isToday){
                displayTasks.push(task);
            }
        });
 
        displayTasks.forEach(task => {
            let isChecked = task.done;

            // localStorage ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚Œã°ãã¡ã‚‰ã‚’å„ªå…ˆ
            if (storedData[task.id] !== undefined) {
                isChecked = storedData[task.id];
            }

            let checkHtml = isToday
                ? `<input type="checkbox"
                    class="task-checkbox"
                    data-task-id="${task.id}"
                    data-is-fixed="${task.is_fixed}"
                    ${isChecked ? "checked" : ""}>`
                : (isChecked
                    ? '<span class="done-icon" style="color:#f19710;">âœ”</span>'
                    : '');
           
            const html = `
            <div class="task-card">
                <div class="task-check">${checkHtml}</div>
                <div class="task-body">
                    <p class="task-title">${task.name} ${task.is_fixed ? '<span class="fixed-label">å›ºå®š</span>' : ''}</p>
                    <p class="task-time">${task.time}</p>
                </div>
            </div>`;
            $list.append(html);
        });
        updateProgress(isToday);
        attachCheckboxHandler();
    }
 
    function updateProgress(isToday){
        const checkboxes = $('.task-checkbox');
        const total = checkboxes.length;
        const completed = checkboxes.filter(':checked').length;
        const percent = total > 0 ? Math.round((completed / total) * 100) : 0;
        const remain = total - completed;
 
        $('#dynamicBar').stop().animate({ 'width': percent + '%' }, 100);
        $('#percentText').text(percent + '%');
 
        if(isToday){
            if(remain > 0) $('#remainHint').html(`ã‚ã¨<span id="remainCount">${remain}</span>ã¤ã®ã‚¿ã‚¹ã‚¯ã§ç›®æ¨™é”æˆã§ã™`);
            else if(total > 0) $('#remainHint').text('ä»Šæ—¥ã®ã‚¿ã‚¹ã‚¯ã¯ã™ã¹ã¦é”æˆã§ã™ï¼');
            else $('#remainHint').text('äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“');
        } else {
            $('#remainHint').text('ã“ã®æ—¥ã®è¨˜éŒ²ã‚’è¡¨ç¤ºä¸­');
        }
        // ğŸ”¥ é”æˆç‡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸åˆ¶å¾¡
        const $message = $('#dailyMessage');

        if(isToday){

            if(total === 0){
                $message.html(`
                    ä»Šæ—¥ã¯äºˆå®šãŒã‚ã‚Šã¾ã›ã‚“ã€‚<br>
                    ã‚†ã£ãã‚Šéã”ã—ã¦ãã ã•ã„ã­ã€‚
                `);
            }
            else if(percent === 100){
                $message.html(`
                    ã™ã¹ã¦é”æˆã§ã™ï¼âœ¨<br>
                    ã¨ã£ã¦ã‚‚ã‚ˆããŒã‚“ã°ã‚Šã¾ã—ãŸã­ã€‚
                `);
            }
            else if(percent >= 50){
                $message.html(`
                    åŠåˆ†ä»¥ä¸Šé”æˆã§ã™ï¼ğŸ‘<br>
                    ã“ã®èª¿å­ã§ã„ãã¾ã—ã‚‡ã†ã€‚
                `);
            }
            else{
                $message.html(`
                    ä»Šæ—¥ã¯ãŸãã•ã‚“ã®äºˆå®šãŒã‚ã‚Šã¾ã™ã€‚<br>
                    ã—ã£ã‹ã‚Šã¨ãŒã‚“ã°ã‚Šã¾ã—ã‚‡ã†ã€‚
                `);
            }

        }
    }
 
    function attachCheckboxHandler(){
        // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ç›´æ¥ã‚¯ãƒªãƒƒã‚¯
        $(document).off('change', '.task-checkbox').on('change', '.task-checkbox', function(){
            const taskId = $(this).data('task-id');
            const done = $(this).is(':checked');

            const dateKey = displayDate.toISOString().split('T')[0];
            const storageKey = "task_done_" + dateKey;

            let storedData = JSON.parse(localStorage.getItem(storageKey) || "{}");
            storedData[taskId] = done;
            localStorage.setItem(storageKey, JSON.stringify(storedData));

            const now = new Date();
            const isToday = (
                new Date(displayDate.getFullYear(), displayDate.getMonth(), displayDate.getDate()).getTime() ===
                new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime()
            );

            updateProgress(isToday);
        });

        // task-cardã‚¯ãƒªãƒƒã‚¯ã§ãƒã‚§ãƒƒã‚¯åˆ‡æ›¿
        $(document).off('click', '.task-card').on('click', '.task-card', function(e){
            // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹è‡ªä½“ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆã¯å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—
            if($(e.target).is('input[type="checkbox"]')) return;

            const $checkbox = $(this).find('.task-checkbox');
            if($checkbox.length === 0) return; // ä»Šæ—¥ã˜ã‚ƒãªã„å ´åˆã¯ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãªã—
            $checkbox.prop('checked', !$checkbox.prop('checked')).trigger('change');
        });
    }
 
    // è©•ä¾¡é¸æŠå‡¦ç†
    $(document).on('click', '.eval-choice', function(){
        const $clicked = $(this);
        $('.eval-choice').removeClass('selected disabled');
        $clicked.addClass('selected');
        $('.eval-choice').not($clicked).addClass('disabled');
        $('#submitEval').prop('disabled', false).addClass('enabled');
    });
 
    // è©•ä¾¡ã™ã‚‹ãƒœã‚¿ãƒ³é€ä¿¡å‡¦ç†
    $(document).on('click', '#submitEval', function(){
        // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
        $('#evalHeader').hide();
        $('#evalStep1').hide();
        $('#evalStep2').fadeIn(300);
        $('#closeModal').hide(); // é€ä¿¡å¾Œã¯Ã—ãƒœã‚¿ãƒ³ã‚’éš ã™
    });
 
    // ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹å‡¦ç†
    $(document).on('click', '#backHome', function(){
        $('#evaluationModal').fadeOut(200, function(){
            // çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆ
            $('#evalHeader').show();
            $('#evalStep1').show();
            $('#evalStep2').hide();
            $('#closeModal').show();
            $('.eval-choice').removeClass('selected disabled');
            $('#submitEval').prop('disabled', true).removeClass('enabled');
        });
    });
 
    $(document).ready(function(){
        refreshDateDisplay();
        // â˜…è¿½åŠ ï¼šæœ€åˆã‹ã‚‰ã‚¿ã‚¹ã‚¯ã‚’è¡¨ç¤º
        $('#task-list').hide();
        $('#toggleTasks').text('ã™ã¹ã¦è¦‹ã‚‹ ï¼');
        $('#prevDate').on('click', function(){ displayDate.setDate(displayDate.getDate() - 1); refreshDateDisplay(); });
        $('#nextDate').on('click', function(){ displayDate.setDate(displayDate.getDate() + 1); refreshDateDisplay(); });
        $('#toggleTasks').on('click', function(){
            const $list = $('#task-list');
            $list.slideToggle(400, function(){
                $('#toggleTasks').text($list.is(':hidden') ? 'ã™ã¹ã¦è¦‹ã‚‹ ï¼' : 'é–‰ã˜ã‚‹ ï¼œ');
            });
        });
 
        const $modal = $('#evaluationModal');
        $('#openEvalModal').on('click', function(){ $modal.fadeIn(200); });
        $('#closeModal').on('click', function(){ $modal.fadeOut(200); });
    });
})();
</script>
{% endblock %}
 